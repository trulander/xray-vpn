#!/bin/bash

echo "üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π nginx-proxy"
echo "========================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ./deploy.sh your-domain.com"
    exit 1
fi

source .env
echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:"
echo "   DOMAIN: ${DOMAIN:-–Ω–µ –∑–∞–¥–∞–Ω}"
echo "   EMAIL: ${EMAIL:-–Ω–µ –∑–∞–¥–∞–Ω}"
echo "   SERVER_IP: ${SERVER_IP:-–Ω–µ –∑–∞–¥–∞–Ω}"
echo

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose down

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π nginx
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
rm -f config/nginx/*_location
rm -f config/nginx/nginx_custom.conf

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ config-generator
echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ config-generator..."
docker-compose build config-generator

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
echo "‚öôÔ∏è  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
docker-compose --profile tools run --rm config-generator generate

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
if [ -f "config/nginx/${DOMAIN}_location" ]; then
    echo "‚úÖ –§–∞–π–ª ${DOMAIN}_location —Å–æ–∑–¥–∞–Ω"
    echo "   –†–∞–∑–º–µ—Ä: $(wc -l < config/nginx/${DOMAIN}_location) —Å—Ç—Ä–æ–∫"
else
    echo "‚ùå –§–∞–π–ª ${DOMAIN}_location –ù–ï —Å–æ–∑–¥–∞–Ω"
    echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ config/nginx/:"
    ls -la config/nginx/ || echo "   –ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞"
fi

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üê≥ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è demo-website:"
docker-compose exec demo-website env | grep -E "(VIRTUAL_HOST|LETSENCRYPT)" || echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ nginx-proxy
echo "üìú –õ–æ–≥–∏ nginx-proxy (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫):"
docker-compose logs --tail=5 nginx-proxy

echo
echo "üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ${DOMAIN} ‚Üí IP —Å–µ—Ä–≤–µ—Ä–∞"
echo "2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–¥–æ 5 –º–∏–Ω—É—Ç)"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: curl -I https://${DOMAIN}"
echo "4. –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ./scripts/diagnose-ssl.sh" 